<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apollo Blog</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/editor.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <header>
        <div class="nav container">
            <a href="/blogShow.html" class="logo">Apollo B<span>log</span></a>
            <li class="navbar">
                <a href="/blogShow.html">Home</a>
                <a href="/map.html">Map</a>
                <a href="/contact.html">Contact</a>
            </li>
            <a href="/blogContentAdd.html" class="editor">
                <i class='bx bx-edit'></i>
            </a>
            <button id="logoutButton" class="login">Logout</button>
        </div>
    </header>
    <div class="banner">
        <!-- Banner burada yer alır (işlevsel kodlara göre düzenlenebilir) -->
    </div>
    <main>
        <div class="blog">
            <div id="access-denied-message" style="display:none;">
                <p>You don't have access to post a blog.</p>
            </div>
            <form id="blog-form" style="display:none;">
                <textarea type="text" class="title" id="yazar-ad-soyad" placeholder="Author Name..."></textarea>
                <textarea type="text" class="title" id="blog-konu" placeholder="Blog Title..."></textarea>
                <textarea type="text" class="article" id="blog-yazisi" placeholder="Blog Text..."></textarea>
                <input type="file" id="blog-image" accept="image/*"> <!-- Resim yükleme input'u -->
                <button type="submit" class="btn dark publish-btn">Blog Paylaş</button>
            </form>
        </div>
        <div class="blog-options">
            <!-- İlave blog seçenekleri burada yer alabilir -->
        </div>
    </main>

    <section class="footer">
        <div class="links">
            <a href="/blogShow.html">Home</a>
            <a href="/map.html">Map</a>
            <a href="/contact.html">Contact</a>
        </div>
        <p>&copy; 2024 Blog App. All rights reserved.</p>
    </section>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDfUfWDEkeVLGyMiRUxlPeiLUT1b-EwOBI",
            authDomain: "yeni-2e76c.firebaseapp.com",
            projectId: "yeni-2e76c",
            storageBucket: "yeni-2e76c.appspot.com",
            messagingSenderId: "470310024312",
            appId: "1:470310024312:web:1a6dc5f5256e09d91ce98d",
            measurementId: "G-GGPZVP4944"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                getDoc(doc(db, "users", user.uid)).then((docSnap) => {
                    if (docSnap.exists() && docSnap.data().role === "admin") {
                        document.getElementById("blog-form").style.display = "block";
                    } else {
                        document.getElementById("access-denied-message").style.display = "block";
                    }
                });
            }
        });

        const logoutButton = document.getElementById('logoutButton');
        logoutButton.addEventListener('click', function () {
            signOut(auth).then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('Çıkış Yaparken Hata Oluştu', error);
            });
        });

        const blogForm = document.getElementById("blog-form");
        
        blogForm.addEventListener("submit", async function(event) {
            event.preventDefault();

            const yazarAdSoyad = document.getElementById("yazar-ad-soyad").value;
            const blogKonu = document.getElementById("blog-konu").value;
            const blogYazisi = document.getElementById("blog-yazisi").value;
            const blogImageFile = document.getElementById("blog-image").files[0];
           
            if (!blogImageFile) {
                console.error("Lütfen bir resim dosyası seçin.");
                return; // Resim seçilmediyse, işlemi durdur.
            }

            const storageRef = ref(storage, 'blogImages/' + blogImageFile.name);
           
            
            try {
                await uploadBytes(storageRef, blogImageFile);
                const imageUrl = await getDownloadURL(storageRef);
                
                await setDoc(doc(collection(db, "blog")), {
                    author: yazarAdSoyad,
                    title: blogKonu,
                    content: blogYazisi,
                    imageUrl: imageUrl 

                });

                console.log("Blog başarıyla Firestore'a eklendi.");
                blogForm.reset();
            } catch (error) {
                console.error("Blog Firestore'a eklenirken hata oluştu:", error);
            }
        });
    </script>
</body>
</html>
